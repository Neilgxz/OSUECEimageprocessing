clear all 
close all
%% picture board
I = imread('Board.jpg');
a=[290,27,1;
    679,132,1;
    184,478,1;
    695,339,1];
c=[162,14,1;
   180,451,1;
   667,12,1;
   702,459,1];
l1=cross(a(1,:),a(2,:));
l2=cross(a(3,:),a(4,:));
p1=cross(l1,l2);
l3=cross(c(1,:),c(2,:));
l4=cross(c(3,:),c(4,:));
p2=cross(l3,l4);
l=cross(p1,p2);
l=l/norm(l);
l=l/l(3);
H1=[1,0,0;
   0,1,0;
   l(1),l(2),l(3)];
H1=H1';
tform = projective2d(H1);
I1= imwarp(I,tform);
c=[13,137,1;
   2069,597,1;
   1060,907,1;
   1042,15,1];
d=[835,133,1;
   1485,837,1;
   850,697,1;
   1834,8,1];
x1=cross(c(1,:),c(2,:));
y1=cross(c(3,:),c(4,:));
x2=cross(d(1,:),d(2,:));
y2=cross(d(3,:),d(4,:));
U=    [ x1(1)*y1(1), (x1(1)*y1(2)+x1(2)*y1(1)) , x1(2)*y1(2); 
        x2(1)*y2(1), (x2(1)*y2(2)+x2(2)*y2(1)),  x2(2)*y2(2)];
P=U'*U;
[V,D]=eig(P);
S=V(:,1)/V(3,1);
G=[S(1),S(2);
    S(2),S(3)];
k22=sqrt(S(3));
k12=S(2)/k22;
k11=sqrt(S(1)-k12^2);
H2=[k11/1.0233,k12/1.0233,0;
    0,k22/1.0233,0;
    0,0,1]; 
H2=H2';
tform1 = projective2d(inv(H2));
I2= imwarp(I1,tform1);
J = imrotate(I2,14);
J=J(1:1500,300:2515,:);
figure
imshow(J)
%% picture rig_original
image= imread('rig_original.jpg');
e=[14,12,1;
    203,9,1;
    20,209,1;
    204,181,1];
l1=cross(e(1,:),e(2,:));
l2=cross(e(3,:),e(4,:));
p1=cross(l1,l2);
l3=cross(e(1,:),e(3,:));
l4=cross(e(2,:),e(4,:));
p2=cross(l3,l4);
l=cross(p1,p2);
l=l/norm(l);
l=l/l(3);
H3=[1,0,0;
   0,1,0;
   l(1),l(2),l(3)];
H3=H3';
tform = projective2d(H3);
image1= imwarp(image,tform);
f=[14,13,1;
   236,13,1;
   21,218,1;
   243,218,1];
x1=cross(f(1,:),f(2,:));
y1=cross(f(2,:),f(4,:));
x2=cross(f(1,:),f(4,:));
y2=cross(f(2,:),f(3,:));
U=    [ x1(1)*y1(1), (x1(1)*y1(2)+x1(2)*y1(1)) , x1(2)*y1(2); 
        x2(1)*y2(1), (x2(1)*y2(2)+x2(2)*y2(1)),  x2(2)*y2(2)];
P=U'*U;
[V,D]=eig(P);
S=V(:,1)/V(3,1);
G=[S(1),S(2);
    S(2),S(3)];
k22=sqrt(S(3));
k12=S(2)/k22;
k11=sqrt(S(1)-k12^2);
H2=[k11/1.0406,k12/1.0406,0;
    0,k22/1.0406,0;
    0,0,1]; 
H2=H2';
tform1 = projective2d(inv(H2));
image2= imwarp(image1,tform1);
figure
imshow(image2)